<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± Ø­Ø±Ø§Ø±ÙŠØ© â€” POS</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body { font-family: Tahoma, sans-serif; direction: rtl; background: #f3f3f3; margin: 0; padding: 0; }
  .header-bar { background: #007bff; color: #fff; padding: 10px; text-align: center; font-weight: bold; }
  .container { width: 820px; max-width: 95%; margin: 12px auto; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
  .panel { background: #fff; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; border-radius: 6px; }
  .product-container, .history-container { width: 250px; }
  .invoice-container { width: 520px; }
  h3 { margin: 6px 0; font-size: 16px; }
  label { display:block; font-size:13px; margin-top:6px; }
  input[type="text"], input[type="number"], select { width: 100%; padding:6px; box-sizing: border-box; margin-top:4px; font-size:14px; }
  button { padding:8px 10px; margin-top:8px; cursor:pointer; font-size:14px; }
  table{ width:100%; border-collapse: collapse; margin-top:8px; }
  table th, table td { border-bottom: 1px dashed #ccc; padding:6px 4px; text-align: center; font-size:13px; }
  .totals { margin-top:8px; border-top:1px solid #eee; padding-top:8px; }
  .totals div { display:flex; justify-content: space-between; margin:4px 0; font-size:14px; }
  .small { font-size:12px; color:#666; }
  .qr-canvas { display:block; margin:auto; }
  .footer-note { text-align:center; color:gray; font-size:12px; margin-top:8px; }
  @media (max-width:900px){
    .container{ flex-direction: column; align-items: center; }
    .product-container, .history-container { width: 95%; }
    .invoice-container { width: 95%; }
  }
</style>
</head>
<body>
  <div class="header-bar">ğŸ’¼ ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ§ØªÙŠØ± Ø±Ù‚ÙŠØ¨ 2025</div>

  <div class="container">
    <!-- Product manager -->
    <div class="panel product-container">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
      <div class="small">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.</div>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="newProductName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø´ÙˆØ±Ø¨Ø©">
      <label>Ø§Ù„Ø³Ø¹Ø±</label><input id="newProductPrice" type="number" min="0" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 25.00">
      <button onclick="addProduct()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>

      <label style="margin-top:10px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</label>
      <select id="productList"><option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹</option></select>
      <div style="margin-top:8px;">
        <button onclick="removeSelectedProduct()">Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±</button>
      </div>
    </div>

    <!-- Main invoice panel -->
    <div class="panel invoice-container">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>

      <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
      <input id="storeName" type="text" value="Ù…ØªØ¬Ø± Ø±Ù‚ÙŠØ¨">

      <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
      <input id="taxNumber" type="text" value="311111111100003">

      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹ Ø§Ù„Ù‡Ø§ØªÙ)</label>
      <input id="address" type="text" value="Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©">

      <div style="display:flex; gap:8px; margin-top:8px;">
        <div style="flex:1;">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
          <input id="phoneNumber" type="text" value="735707210">
        </div>
        <div style="width:160px;">
          <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
          <input id="vatRate" type="number" min="0" max="100" step="0.01" value="15">
          <label style="font-size:13px; margin-top:6px;"><input id="disableVAT" type="checkbox" onchange="calculateGrandTotal()"> ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
        </div>
      </div>

      <label>Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ±</label>
      <input id="cashierName" type="text" value="ÙƒØ§Ø´ÙŠØ± 1">

      <h3 style="margin-top:10px;">Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
      <table id="itemsTable">
        <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody id="itemsBody"></tbody>
      </table>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button onclick="addItemFromList()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        <button onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
        <button onclick="clearItems()">Ù…Ø³Ø­ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
      </div>

      <div class="totals">
        <div><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span><span id="subTotalDisplay">0.00</span></div>
        <div><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span><span id="vatAmountDisplay">0.00</span></div>
        <div style="border-top:1px dashed #ccc; padding-top:6px;"><span style="font-weight:bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span><span id="grandTotalDisplay" style="font-weight:bold">0.00</span></div>
      </div>

      <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
      <input id="paidAmount" type="number" value="0" step="0.01" oninput="updateQR()">

      <h3 style="margin-top:10px;">QR Code</h3>
      <canvas id="qrCanvas" class="qr-canvas" width="220" height="220" style="width:220px;height:220px;"></canvas>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        <button onclick="openPrintPage()">ğŸ–¨ï¸ Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>

      <div class="footer-note">Ø§Ù„Ø±Ù‚ÙŠØ¨ Ù„Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¨Ø±Ù…Ø¬Ø©/Øª: 735707210</div>
    </div>

    <!-- History and actions -->
    <div class="panel history-container">
      <h3>Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
      <div class="small">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (localStorage)</div>
      <label>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</label>
      <select id="invoiceHistory"><option value="">-- Ø§Ø®ØªØ± ÙØ§ØªÙˆØ±Ø© --</option></select>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button onclick="loadSelectedInvoiceForEdit()">âœï¸ ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="printSelectedInvoice()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button onclick="deleteSelectedInvoice()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button onclick="exportInvoices()">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ JSON</button>
      </div>

      <div style="margin-top:12px;">
        <label>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙÙˆØ§ØªÙŠØ± (JSON)</label>
        <input type="file" id="importInvoicesFile" accept="application/json" onchange="importInvoices(event)">
      </div>
    </div>
  </div>

<script>
/* ======== Helpers and state ======== */
let itemCounter = 0;
let products = [];
let invoices = [];

function escapeHtml(s){
  if(s===null||s===undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ======== Products management ======== */
function addProduct(){
  const name = document.getElementById('newProductName').value.trim();
  const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
  if(!name || price <= 0){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ³Ø¹Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§'); return; }
  products.push({ name, price: price.toFixed(2) });
  saveProductsToStorage();
  updateProductSelect();
  document.getElementById('newProductName').value='';
  document.getElementById('newProductPrice').value='';
}
function updateProductSelect(){
  const sel = document.getElementById('productList');
  sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹</option>';
  products.forEach((p,i)=> sel.innerHTML += `<option value="${i}">${escapeHtml(p.name)} â€” ${p.price}</option>`);
}
function removeSelectedProduct(){
  const sel = document.getElementById('productList');
  const idx = sel.value;
  if(idx===''){ alert('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹ Ù„Ù„Ø­Ø°Ù'); return; }
  products.splice(idx,1);
  saveProductsToStorage();
  updateProductSelect();
}
function saveProductsToStorage(){ localStorage.setItem('productList', JSON.stringify(products)); }
function loadProductsFromStorage(){ products = JSON.parse(localStorage.getItem('productList')||'[]'); updateProductSelect(); }

/* ======== Invoice items ======== */
function addItem(desc='Ù…Ù†ØªØ¬', price=0){
  itemCounter++;
  const tbody = document.getElementById('itemsBody');
  const tr = document.createElement('tr');
  tr.id = 'item-'+itemCounter;
  tr.innerHTML = 