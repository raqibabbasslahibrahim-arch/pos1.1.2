<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹ â€” POS ÙƒØ§Ù…Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&display=swap" rel="stylesheet">
<style>
body {font-family:'Cairo',sans-serif; background: linear-gradient(to bottom,#E3EAF0,#90A4AE); margin:0; padding:0; display:flex;}
#sidebar{width:250px; background:#fff; border-left:2px solid #64B5F6; padding:10px; box-shadow:-2px 0 5px #90CAF9; height:100vh; overflow:auto;}
#mainScreen{flex:1; padding:15px;}
h1,h2,h3{text-align:center;color:#0D47A1;margin:5px 0;}
h1{font-size:26px;font-weight:700;text-shadow:1px 1px #90CAF9;}
h2{font-size:18px;font-weight:600;}
input,select,button{padding:6px;margin:3px 0;border-radius:6px;border:1px solid #64B5F6;font-size:14px;}
button{background:#1976D2;color:#fff;cursor:pointer;font-weight:700;transition:0.3s;}
button:hover{background:#0D47A1;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
td,th{border:1px solid #64B5F6;padding:5px;text-align:center;}
td input,td select{width:70px;}
#addProductForm{background:#E3F2FD;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;gap:5px;align-items:center;}
#addProductForm input, #addProductForm select{flex:1;}
#addProductForm button{flex:none;}
#commandBar{display:flex;justify-content:space-around;position:fixed;bottom:0;left:0;width:100%;background:#E3F2FD;padding:5px;box-shadow:0 -2px 5px #90CAF9;}
#commandBar button{flex:1;margin:0 3px;font-size:14px;}
#returnsList{max-height:150px; overflow:auto; border:1px solid #64B5F6; padding:5px; border-radius:6px; margin-top:5px;}
#currencySelect{width:100%;padding:5px;margin-bottom:5px;border:1px solid #64B5F6;border-radius:6px;}
#footer{margin-top:20px;text-align:center;font-size:12px;color:#555;}
</style>
</head>
<body>

<div id="sidebar">
  <h3>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
  <select id="currencySelect" onchange="updateInvoice()">
    <option value="SAR">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</option>
    <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</option>
    <option value="YER">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</option>
  </select>
  <input type="text" id="productSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯" oninput="filterProducts()" style="width:100%;padding:5px;margin-bottom:5px;border:1px solid #64B5F6;border-radius:6px;">
  <div id="productList" style="max-height:200px; overflow:auto; margin-bottom:10px; border:1px solid #64B5F6; padding:5px; border-radius:6px;"></div>
  <button onclick="refreshProductList()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

  <hr>

  <h3>â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
  <input type="text" id="newCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù">
  <input type="text" id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
  <select id="newUnit">
    <option value="Ø­Ø¨Ø©">Ø­Ø¨Ø©</option>
    <option value="Ø¯Ø±Ø²Ù†">Ø¯Ø±Ø²Ù†</option>
    <option value="ÙƒØ±ØªÙˆÙ†">ÙƒØ±ØªÙˆÙ†</option>
  </select>
  <input type="number" id="newPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©">
  <input type="number" id="newQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <button onclick="addNewProduct()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button>

  <hr>
  <h3>ğŸ“ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±Ø¬Ø¹Ø©</h3>
  <div id="returnsList"></div>
</div>

<div id="mainScreen">
  <h1>Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹</h1>

  <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±:</label>
  <input type="text" id="storeName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±">
  <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…ØªØ¬Ø±:</label>
  <input type="text" id="storeTax" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ">
  <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø±:</label>
  <input type="text" id="storeAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø±">
  <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
  <input type="text" id="storePhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">

  <label>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ / Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</label>
  <input type="text" id="cashierName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨">

  <div id="addProductForm">
    <input type="text" id="barcodeInput" placeholder="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯">
    <select id="productQty"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
    <input type="number" id="vatPercent" placeholder="Ù‚ÙŠÙ…Ø© Ù…Ø¶Ø§ÙØ© %" value="5" min="0" style="width:80px;">
    <button onclick="addProductFromInput()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¶Ø±ÙŠØ¨Ø© ÙƒÙ„ ØµÙ†Ù</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="invoiceBody"></tbody>
  </table>

  <h3>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
  <input type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
  <input type="text" id="customerNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" onblur="fetchCustomer()">
  <input type="text" id="customerTax" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„">

  <div style="margin-top:10px;">
    <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
    <select id="paymentMethod">
      <option value="cash">ÙƒØ§Ø´</option>
      <option value="card">Ø´Ø¨ÙƒØ© / Ø¨Ø·Ø§Ù‚Ø©</option>
      <option value="other">Ø£Ø®Ø±Ù‰</option>
    </select>
    <button onclick="setPaymentNetwork()">Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¨ÙƒØ© (F6)</button>
  </div>

  <div id="total" style="margin-top:10px;font-weight:700;font-size:18px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 SAR</div>
  <div id="footer">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø±Ù‚ÙŠØ¨ Ù„Ù„Ø¨Ø±Ù…Ø¬Ø©</div>
</div>

<div id="commandBar">
  <button onclick="focusBarcode()">F4 Ø¨Ø­Ø« Ù…Ù†ØªØ¬</button>
  <button onclick="saveOnly()">F9 Ø­ÙØ¸ ÙÙ‚Ø·</button>
  <button onclick="saveAndPrint()">F10 Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
  <button onclick="clearInvoice()">F3 Ù…Ø³Ø­</button>
  <button onclick="closeAccount()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
</div>

<script>
// ===== Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
let products = JSON.parse(localStorage.getItem('products') || '[]');
let invoiceItems = [];
let discountPercent = 0;
let sales = JSON.parse(localStorage.getItem('sales') || '[]');
let customers = JSON.parse(localStorage.getItem('customers') || '[]');
let currency = document.getElementById('currencySelect').value || 'SAR';

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====
function unitToCount(qty,unit){
  switch(unit){
    case 'Ø­Ø¨Ø©': return qty;
    case 'Ø¯Ø±Ø²Ù†': return qty*12;
    case 'ÙƒØ±ØªÙˆÙ†': return qty*24;
    default: return qty;
  }
}
function saveProducts(){localStorage.setItem('products', JSON.stringify(products));}
function saveSales(){localStorage.setItem('sales', JSON.stringify(sales));}
function saveCustomers(){localStorage.setItem('customers', JSON.stringify(customers));}
function saveStoreInfo(){
  localStorage.setItem('storeName', document.getElementById('storeName').value);
  localStorage.setItem('storeTax', document.getElementById('storeTax').value);
  localStorage.setItem('storeAddress', document.getElementById('storeAddress').value);
  localStorage.setItem('storePhone', document.getElementById('storePhone').value);
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ =====
function fetchCustomer(){
  const number = document.getElementById('customerNumber').value.trim();
  const cust = customers.find(c=>c.number===number);
  if(cust){
    document.getElementById('customerName').value = cust.name;
    document.getElementById('customerTax').value = cust.tax;
  }
}

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function updateInvoice(){
  const tbody=document.getElementById('invoiceBody'); tbody.innerHTML=''; 
  let sum=0;
  invoiceItems.forEach((item,index)=>{
    let itemTotal = item.total;
    let itemVatAmount = itemTotal * (item.vat/100);
    sum += itemTotal + itemVatAmount;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.name}</td>
      <td><input type="number" value="${item.qty}" min="1" onchange="updateQty(${index},this.value)"></td>
      <td><select onchange="updateUnit(${index},this.value)">
        <option value="Ø­Ø¨Ø©" ${item.unit==='Ø­Ø¨Ø©'?'selected':''}>Ø­Ø¨Ø©</option>
        <option value="Ø¯Ø±Ø²Ù†" ${item.unit==='Ø¯Ø±Ø²Ù†'?'selected':''}>Ø¯Ø±Ø²Ù†</option>
        <option value="ÙƒØ±ØªÙˆÙ†" ${item.unit==='ÙƒØ±ØªÙˆÙ†'?'selected':''}>ÙƒØ±ØªÙˆÙ†</option>
      </select></td>
      <td><input type="number" value="${item.price}" onchange="updatePrice(${index},this.value)"></td>
      <td>${item.total.toFixed(2)}</td>
      <td>${(itemVatAmount).toFixed(2)}</td>
      <td>${item.stock}</td>
      <td><button onclick="removeItem(${index})">âŒ</button></td>`;
    tbody.appendChild(tr);
  });
  if(discountPercent>0) sum = sum*(1-discountPercent/100);
  document.getElementById('total').textContent="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+sum.toFixed(2)+" "+currency;
}

// ===== Ø§Ù„Ø£ØµÙ†Ø§Ù =====
function addNewProduct(){
  const code=document.getElementById('newCode').value.trim();
  const name=document.getElementById('newName').value.trim();
  const unit=document.getElementById('newUnit').value;
  const price=parseFloat(document.getElementById('newPrice').value);
  const qty=parseInt(document.getElementById('newQty').value);
  if(!code || !name || isNaN(price) || isNaN(qty)){alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­"); return;}
  if(products.find(p=>p.code===code)){alert("Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return;}
  const newProduct={code,name,unit,price,quantity:qty};
  products.push(newProduct); saveProducts(); refreshProductList();
  document.getElementById('newCode').value=''; document.getElementById('newName').value='';
  document.getElementById('newPrice').value=''; document.getElementById('newQty').value='';
  alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
}

function refreshProductList(){
  const listDiv=document.getElementById('productList'); listDiv.innerHTML='';
  if(products.length===0){ listDiv.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª"; return;}
  products.forEach(p=>{
    const btn=document.createElement('button'); btn.style.width="100%"; btn.style.marginBottom="3px";
    btn.textContent=`${p.code} - ${p.name} (${p.quantity})`; 
    btn.onclick=()=>{ addProductByCode(p.code); };
    listDiv.appendChild(btn);
  });
}

function filterProducts(){
  const search=document.getElementById('productSearch').value.toLowerCase();
  const filtered=products.filter(p=>p.code.toLowerCase().includes(search) || p.name.toLowerCase().includes(search));
  const listDiv=document.getElementById('productList'); listDiv.innerHTML='';
  if(filtered.length===0){listDiv.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª"; return;}
  filtered.forEach(p=>{
    const btn=document.createElement('button'); btn.style.width="100%"; btn.style.marginBottom="3px";
    btn.textContent=`${p.code} - ${p.name} (${p.quantity})`; btn.onclick=()=>{ addProductByCode(p.code); };
    listDiv.appendChild(btn);
  });
}

// ===== Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© =====
function addProductFromInput(){ 
  const code=document.getElementById('barcodeInput').value.trim();
  if(code) addProductByCode(code);
  document.getElementById('barcodeInput').value='';
}

function addProductByCode(code){
  // Ø¯Ø¹Ù… Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ØªØºÙŠØ± (Ø¨Ø¯Ø§ÙŠØ© 99) Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø³Ø¹Ø± â€” Ø§Ø­ØªÙØ¸Ù†Ø§ Ø¨Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¥Ù† Ù„Ø²Ù…
  function parseVariableBarcode(c){
    if(c.startsWith('99') && c.length>=12){
      let sectionCode = c.substring(0,3);
      // Ø§Ù„Ø³Ø¹Ø± ÙÙŠ Ù…ÙˆØ§Ø¶Ø¹ Ù…Ø­Ø¯Ø¯Ø© (Ù…Ø«Ø§Ù„): 7-11
      let pricePart = c.substring(7,12);
      let price = parseInt(pricePart)/100;
      let sectionName = '';
      switch(sectionCode){
        case '991': sectionName='Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡'; break;
        case '992': sectionName='Ø£Ø¬Ø¨Ø§Ù† ÙˆÙ…Ø®Ù„Ù„Ø§Øª'; break;
        case '993': sectionName='Ù…ÙƒØ³Ø±Ø§Øª ÙˆØ¨Ù‡Ø§Ø±Ø§Øª'; break;
        case '994': sectionName='Ø®Ø¨Ø² ÙˆÙ…Ø¹Ø¬Ù†Ø§Øª'; break;
        case '995': sectionName='Ø­Ù„ÙˆÙŠØ§Øª ÙˆØ²Ù†'; break;
        default: sectionName='Ø¹Ù†ØµØ± Ù…ØªØºÙŠØ±';
      }
      return {name: sectionName, price: price};
    }
    return null;
  }

  let variable = parseVariableBarcode(code);
  let qty = parseInt(document.getElementById('productQty').value)||1;
  let vat = parseFloat(document.getElementById('vatPercent').value)||0;

  if(variable){
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ± (Ø³Ø¹Ø± Ù…Ù† Ø§Ù„ÙƒÙˆØ¯)
    let name = variable.name;
    let price = variable.price;
    let total = price * qty;
    invoiceItems.push({code:code,name:name,qty:qty,unit:'ÙƒØ¬Ù…',price:price,total:total,vat:vat,stock:'âˆ'});
    updateInvoice();
    return;
  }

  let product = products.find(p => p.code === code);
  if(!product){ alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }
  const qtyInUnit = unitToCount(qty, product.unit);
  if(product.quantity < qtyInUnit){ alert("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"); return; }
  product.quantity -= qtyInUnit;
  saveProducts();
  const total = product.price * qtyInUnit;
  let existing = invoiceItems.find(item => item.code === code);
  if(existing){
    existing.qty += qty;
    existing.total = existing.price * unitToCount(existing.qty, existing.unit);
    existing.vat = vat;
  } else {
    invoiceItems.push({code: product.code, name: product.name, qty: qty, unit: product.unit, price: product.price, total: total, vat: vat, stock: product.quantity});
  }
  updateInvoice();
  refreshProductList();
}

// ===== ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function updateQty(i,v){ const item = invoiceItems[i]; let val=parseFloat(v)||1; item.qty=val; recalcItem(i);}
function updateUnit(i,v){invoiceItems[i].unit=v; recalcItem(i);}
function updatePrice(i,v){invoiceItems[i].price=parseFloat(v)||0; recalcItem(i);}
function recalcItem(i){ const item=invoiceItems[i]; item.total=item.price*item.qty; updateInvoice();}
function removeItem(i){invoiceItems.splice(i,1); updateInvoice(); refreshProductList();}

// ===== Ø®ØµÙ… =====
function addDiscount(){let d=parseFloat(prompt("Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %:", discountPercent)); if(!isNaN(d)) discountPercent=d; updateInvoice();}

// ===== Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function clearInvoice(){invoiceItems=[]; discountPercent=0; updateInvoice();}

// ===== Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function saveOnly(){
  if(invoiceItems.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª"); return;}
  saveStoreInfo();
  let cashier=document.getElementById('cashierName').value||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  let store=document.getElementById('storeName').value||"Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹";
  let storeTax=document.getElementById('storeTax').value||"";
  let storeAddress=document.getElementById('storeAddress').value||"";
  let storePhone=document.getElementById('storePhone').value||"";
  let customerName=document.getElementById('customerName').value||"";
  let customerNumber=document.getElementById('customerNumber').value||"";
  let customerTax=document.getElementById('customerTax').value||"";
  let paymentMethod = document.getElementById('paymentMethod').value || 'cash';
  // Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  if(customerNumber && !customers.find(c=>c.number===customerNumber)){
    customers.push({number:customerNumber,name:customerName,tax:customerTax});
    saveCustomers();
  }
  sales.push({date:new Date(), cashier, store, storeTax, storeAddress, storePhone, customerName, customerNumber, customerTax, items:invoiceItems, discount:discountPercent, currency, paymentMethod});
  saveSales();
  invoiceItems=[]; discountPercent=0;
  updateInvoice();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­");
}

// ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© =====
function saveAndPrint(){
  if(invoiceItems.length===0){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª"); return;}
  saveStoreInfo();
  let cashier=document.getElementById('cashierName').value||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  let store=document.getElementById('storeName').value||"Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹";
  let storeTax=document.getElementById('storeTax').value||"";
  let storeAddress=document.getElementById('storeAddress').value||"";
  let storePhone=document.getElementById('storePhone').value||"";
  let customerName=document.getElementById('customerName').value||"";
  let customerNumber=document.getElementById('customerNumber').value||"";
  let customerTax=document.getElementById('customerTax').value||"";
  let paymentMethod = document.getElementById('paymentMethod').value || 'cash';

  let win=window.open('','width=400,height=600');
  win.document.write('<html><head><title>ÙØ§ØªÙˆØ±Ø© POS</title><meta charset="utf-8"><style>body{font-family:Cairo;text-align:right;padding:10px;}table{width:100%;border-collapse:collapse;}td,th{padding:4px;border-bottom:1px solid #90CAF9;}</style></head><body>');
  win.document.write('<h3 style="color:#0D47A1;">'+store+'</h3>');
  if(storeTax) win.document.write('<p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: '+storeTax+'</p>');
  if(storeAddress) win.document.write('<p>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: '+storeAddress+'</p>');
  if(storePhone) win.document.write('<p>Ø§Ù„Ù‡Ø§ØªÙ: '+storePhone+'</p>');
  win.document.write('<p>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: '+cashier+'</p>');
  win.document.write('<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø¶Ø±ÙŠØ¨Ø©</th></tr>');
  invoiceItems.forEach(item=>{
    let itemVatAmount = (item.total * item.vat/100);
    win.document.write(`<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.unit}</td><td>${item.price.toFixed(2)}</td><td>${item.total.toFixed(2)}</td><td>${itemVatAmount.toFixed(2)}</td></tr>`);
  });
  let totalSum = invoiceItems.reduce((acc,item)=> acc + item.total + (item.total*item.vat/100),0);
  totalSum = totalSum * (1 - (discountPercent||0)/100);
  win.document.write('</table><p>Ø§Ù„Ø®ØµÙ…: '+(discountPercent||0)+'%</p>');
  win.document.write('<p style="font-weight:bold;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©: '+totalSum.toFixed(2)+' '+currency+'</p>');
  if(customerName || customerNumber || customerTax){
    win.document.write('<hr>');
    win.document.write('<p>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: '+customerName+'</p>');
    win.document.write('<p>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: '+customerNumber+'</p>');
    win.document.write('<p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„: '+customerTax+'</p>');
  }
  win.document.write('<p>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: '+(paymentMethod==='cash'?'ÙƒØ§Ø´': paymentMethod==='card'?'Ø´Ø¨ÙƒØ© / Ø¨Ø·Ø§Ù‚Ø©':'Ø£Ø®Ø±Ù‰')+'</p>');
  let invoiceNumber = Math.floor(Math.random()*1000000);
  win.document.write('<p style="text-align:center;"><img src="https://api.qrserver.com/v1/create-qr-code/?data=ÙØ§ØªÙˆØ±Ø©-'+invoiceNumber+'&size=100x100" alt="QR"></p>');
  win.document.write('<p style="text-align:center;color:#1565C0;font-weight:bold;">ğŸ’™ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… ğŸ’™</p>');
  win.document.write('</body></html>');
  win.document.close();
  win.print();
  saveOnly();
}

// ===== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ =====
function closeAccount(){
  let cashier = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ù„ØºÙ„Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨","");
  if(!cashier) return;
  let todaySales = sales.filter(s=>s.cashier===cashier);
  let total = todaySales.reduce((sum,s)=>sum + s.items.reduce((a,b)=>a+b.total + b.total*b.vat/100,0)*(1-(s.discount||0)/100),0);
  alert(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ÙƒØ§Ø´ÙŠØ± ${cashier}: ${total.toFixed(2)} ${currency}`);
}

// ===== Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ =====
function setPaymentNetwork(){ document.getElementById('paymentMethod').value='card'; }

// ===== Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ =====
let barcodeBuffer = '';
let barcodeTimer;
document.addEventListener('keypress', function(e) {
  if(barcodeTimer) clearTimeout(barcodeTimer);
  if(e.key !== 'Enter'){
    barcodeBuffer += e.key;
    barcodeTimer = setTimeout(() => {
      if(barcodeBuffer.length >= 3) addProductByCode(barcodeBuffer);
      barcodeBuffer = '';
    }, 100);
  } else {
    if(barcodeBuffer.length > 0){
      addProductByCode(barcodeBuffer);
      barcodeBuffer = '';
    }
  }
});

// ===== Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ =====
document.addEventListener('keydown',function(e){
  switch(e.key){
    case 'F4': document.getElementById('barcodeInput').focus(); break;
    case 'F6': setPaymentNetwork(); break; // Ø§Ù„Ø´Ø¨ÙƒØ©
    case 'F8': addDiscount(); break; // Ø®ØµÙ…
    case 'F9': saveOnly(); break;
    case 'F10': saveAndPrint(); break;
    case 'F3': clearInvoice(); break;
  }
});

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… =====
document.getElementById('storeName').value=localStorage.getItem('storeName')||'';
document.getElementById('storeTax').value=localStorage.getItem('storeTax')||'';
document.getElementById('storeAddress').value=localStorage.getItem('storeAddress')||'';
document.getElementById('storePhone').value=localStorage.getItem('storePhone')||'';
refreshProductList();
updateInvoice();
</script>

</body>
</html>
